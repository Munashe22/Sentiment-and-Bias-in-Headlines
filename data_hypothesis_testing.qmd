---
title: "Data Hypothesis Testing"
format: html
---


Reading in Sentiment Data


```{r}
library(arrow) #Library Needed to Read Parquet Files in R
library(dplyr)
library(effectsize)
library(ggplot2)
library(reshape2)
options(arrow.skip_nul = TRUE)
```



Reading in Data by Country
```{r}
df_america <- read_parquet('data/us_data_final.parquet')
head(df_america)
```

```{r}
df_china <- read_parquet('data/china_data_final.parquet')
head(df_china)
```

```{r}
df_russia <- read_parquet('data/russia_data_final.parquet')
head(df_russia)
```

```{r}
df_argentina <- read_parquet('data/argentina_data_final.parquet')
head(df_argentina)
```

```{r}
df_india <- read_parquet('data/india_data_final.parquet')
head(df_india)
```

```{r}
df_italy <- read_parquet('data/italy_data_final.parquet')
head(df_italy)
```

```{r}
df_canada <- read_parquet('data/canada_data_final.parquet')
head(df_canada)
```




1 Sample T-Test: Comparison of Sentiment Scores in US to Sentiment Scores in Russia

Within our data, Sentiment in news articles is split into 3 sections: negative sentiment, neutral sentiment, and positive sentiment, but also gives us a 'compound sentiment score' that grades the aritcle's headline from a score of -1 to 1.   



H0: The mean compound sentiment score for recorded articles in the United States before 2023 is 0 ($\mu_C =0$)
Ha: The mean of the compound sentiment score for recorded articles in the United States before 2023 is not 0 ($\mu_C \neq 0$)


Applying Bootstrap Sampling to The T-Test

We took samples of N = 1000 articles repeated 1000 times for our 92,497 articles to use bootstrap sampling

```{r}
library(ggplot2)
set.seed(5100)
n <- 1000
Num_Samples <- 1000

US_Sentiment_Means <- numeric(Num_Samples)
for(i in 1:Num_Samples){
    bootstrap_samp <- sample(df_america$compound, size=n, replace=TRUE)
    US_Sentiment_Means[i] <- mean(bootstrap_samp)
}
cat("US Bootstrap Mean Compund Sentiment Score Summary")
summary(US_Sentiment_Means)


#Histogram of Bootstrap Means
hist(US_Sentiment_Means, main = "Bootstrap Mean Distribution for US Sentiment Scores", xlab= "Sample Mean Compound Sentiment Score", col="blue", breaks=25)
```

```{r}
t.test(US_Sentiment_Means, mu = 0)
```

If we assume alpha = 0.05, the p-value being less than 2.2e-16 allows us to reject our null hypothesis and conclude that in the United States, the average compound sentiment score of news article headlines is not 0.  Futhermore, because our t-test provided us with a 95% confidence interval due to our bootstrap sampling, we can also conclude that we are 95% confident that the true average compound sentiment score for news articles in the United States is between 0.007 and 0.009.


2 Sample T-Test: United States Compound Sentiment Scores vs Russia Compound Sentiment Scores

While our 95% confidence interval shows us that the true mean compound sentiment score of the US article headlines is between 0.007 and 0.009, we're curious to see how that compares to another country's headlines.  For this 2-Sample T-Test, we'll be comparing the mean compound sentiment scores of article headlines in the United States with the mean compound sentiment scores of Russia's headlines using the same bootstrap sampling parameters as our previous example with the United States.  

H0: The difference between mean compound sentiment scores for articles from Russia and articles from the United States is 0
Ha:  The difference between mean compound sentiment scores for articles from Russia and articles from the United States is not 0

```{r}
set.seed(5100)
n <- 1000
Num_Samples <- 1000

Russian_Sentiment_Means <- numeric(Num_Samples)
for(i in 1:Num_Samples){
    bootstrap_samp <- sample(df_russia$compound, size=n, replace=TRUE)
    Russian_Sentiment_Means[i] <- mean(bootstrap_samp)
}
cat("Russian Bootstrap Mean Compund Sentiment Score Summary")
summary(Russian_Sentiment_Means)
```

```{r}
t.test(Russian_Sentiment_Means, US_Sentiment_Means)
```




Because our p-value is less than 2.2e-16, we can reject our null hypothesis at the 0.05 level and conclude that there is statistical evidence that the mean compound sentiment score of Russian article headlines is different than the mean compound sentiment score of United States article headlines.  Furthermore, based on our 95% confidence interval, we can also conclude that the true difference in mean compound sentiment scores between Russian article headlines and US article headlines is between 0.015 and 0.017


ANOVA 1: Does Compund Sentiment Score Differ by Country?

While it is interesting that there is statistical evidence of a difference in mean compound sentiment scores between Russian article headlines and United States article headlines, We are curious to see if this applies to every country.  Therefore, we decided to combine all of our data frames into one and ran an ANOVA test to see if this applies to every country.

H0: All countries in our data have equal mean compound sentiment scores 
Ha: At least one country has a different mean compound sentiment score

```{r}
df_all_countries <- rbind(df_america, df_china, df_russia, df_canada, df_india, df_italy, df_argentina)
counts <- as.data.frame(table(df_all_countries$location))
counts
```

```{r}

anova_compound_country <- aov(compound ~location, data=df_all_countries)
summary(anova_compound_country)

TukeyHSD(anova_compound_country)
eta_squared(anova_compound_country)
```

Conclusion: We can reject H0 and conclude that there are statistically significant differences in bias scores across countries, with our TukeyHSD shows which specific country pairs differ significantly.


```{r}
anova_bias_country <- aov(bias_score ~location, data=df_all_countries)
summary(anova_bias_country)

TukeyHSD(anova_bias_country)
eta_squared(anova_bias_country)
```

ANOVA 3: Does An Article's Country * Category Determine Its Compound Sentiment Score?

After proving that where an article is published affects its Mean Compound Sentiment Score, we became curious to see if the category/genre also affects an article's compound sentiment score.

H0: All article categories * countries have equal mean sentiment
Ha: At least one article category has a different mean compound sentiment score

```{r}
anova_compound_country_category <- aov(compound ~ category * location, data = df_all_countries)
summary(anova_compound_country_category)
p <- TukeyHSD(anova_compound_country_category)
table(df_all_countries$location, df_all_countries$category)
eta_squared(anova_compound_country_category)
```

Significant US Health Articles:
 Health US: Health China
 Health US: General Italy
 Health US: General Russian
 Health US: Health Russian

```{r}
file_content <- readLines("data/Tukey_HSD_p_values.txt")
head(file_content, 50)


lines <- readLines("data/Tukey_HSD_p_values.txt")
cat("Total lines in file:", length(lines), "\n")

comparisons <- character(length(lines))
p_values <- numeric(length(lines))

for(i in 1:length(lines)) {
  line <- trimws(lines[i])  
  if(nchar(line) > 0) {
    parts <- strsplit(line, "\\s{2,}")[[1]]  
    if(length(parts) >= 2) {
      comparisons[i] <- trimws(parts[1])
      p_values[i] <- as.numeric(trimws(parts[length(parts)]))
    } else {
      words <- strsplit(line, "\\s+")[[1]]
      if(length(words) >= 2) {
        comparisons[i] <- paste(words[1:(length(words)-1)], collapse = " ")
        p_values[i] <- as.numeric(words[length(words)])
      }
    }
  }
}

tukey_df <- data.frame(
  comparison = comparisons,
  p.adj = p_values,
  stringsAsFactors = FALSE
)

cat("Lines parsed:", length(lines), "\n")
cat("Valid comparisons:", sum(nchar(tukey_df$comparison) > 0), "\n")
cat("Valid p-values:", sum(!is.na(tukey_df$p.adj)), "\n")

tukey_df <- tukey_df[!is.na(tukey_df$p.adj), ]
colnames(tukey_df)[1] <- "category:country-category:country"

str(tukey_df)
head(tukey_df, 10)
dim(tukey_df)

cat("Summary of adjusted p-values:\n")
summary(tukey_df$p.adj)
cat("\nNumber of significant comparisons (p < 0.05):", sum(tukey_df$p.adj < 0.05, na.rm = TRUE))
cat("\nTotal number of comparisons:", nrow(tukey_df))
cat("\nProportion significant:", round(sum(tukey_df$p.adj < 0.05, na.rm = TRUE)/nrow(tukey_df), 3))

hist(tukey_df$p.adj, 
     main = "Distribution of 1000+ p-values", 
     xlab = "p-value",
     breaks = 50,
     col = "lightblue")

abline(v = 0.05, col = "red", lwd = 2, lty = 2)
```

Conclusion: Reject Null Hypothesis, Article category significantly affects compound sentiment scores


Chi-Square Test of Independence: Comparing Sentiment Category to Bias Category

H0: Sentiment category and Bias category are independent
Ha: Sentiment category and bias category are associated

```{r}
all_sentiment_bias <- table(df_all_countries$sentiment_category, df_all_countries$bias_category)
table(df_all_countries$sentiment_category)
table(df_all_countries$bias_category)
chi_sentiment_bias <- chisq.test(all_sentiment_bias)
chi_sentiment_bias
print(round(chi_sentiment_bias$expected))
print(round(chi_sentiment_bias$residuals))
```


```{r}
all_sentiment_bias <- table(df_all_countries$sentiment_category, df_all_countries$bias_category)

sentiment_bias_df <- as.data.frame(all_sentiment_bias)
colnames(sentiment_bias_df) <- c("Sentiment", "Bias", "Frequency")

p1 <- ggplot(sentiment_bias_df, aes(x = Bias, y = Sentiment, fill = Frequency)) +
  geom_tile(color = "white", size = 0.5) +
  geom_text(aes(label = Frequency), color = "white", size = 4, fontface = "bold") +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(title = "Sentiment Category vs Bias Category",
       subtitle = paste("Chi-square =", round(chi_sentiment_bias$statistic, 2), 
                       ", p-value =", format(chi_sentiment_bias$p.value, scientific = TRUE)),
       x = "Bias Category",
       y = "Sentiment Category") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        plot.subtitle = element_text(hjust = 0.5, size = 12))

print(p1)
```

Conclusion: they are associated

Chi-Square Test 2: Genre X Sentiment Category

```{r}
counts <- t(as.data.frame(table(df_america$category)))
counts
```


```{r}

all_sentiment_genre <- table(df_all_countries$category, df_all_countries$sentiment_category)


chi_sentiment_genre <- chisq.test(all_sentiment_genre)
chi_sentiment_genre
summary(chi_sentiment_genre)
```

Time Series

```{r}
library(lubridate)
library(Kendall)
df_all_countries$publishedAt <- as.Date(df_all_countries$publishedAt)
df_all_countries$year_month <- floor_date(df_all_countries$publishedAt, "month")

monthly_sent <- df_all_countries |> group_by(year_month) |> summarize(monthly_mean = mean(compound, na.rm=TRUE))

trend_model <- lm(monthly_mean ~ year_month, data=monthly_sent)
summary(trend_model)
MannKendall(monthly_sent$monthly_mean)
```


```{r}
monthly_sent$month <- factor(month(monthly_sent$year_month), labels = month.abb)

seasonal_anova <- aov(monthly_mean ~ month, data=monthly_sent)

summary(seasonal_anova)
TukeyHSD(seasonal_anova)

plot(monthly_sent$month, monthly_sent$monthly_mean, main="Monthly Mean Sentiment", xlab="Month", ylab="Sentiment")
```

```{r}
monthly_country <- df_all_countries |> group_by(location, year_month) |> summarize(monthly_mean = mean(compound, na.rm=TRUE)) |> ungroup()

monthly_country$time_index <- as.numeric(monthly_country$year_month)

trend_country_model <- lm(monthly_mean ~ time_index * location, data=monthly_country)

summary(trend_country_model)

```

```{r}

monthly_bias <- df_all_countries |> group_by(year_month) |> summarize(monthly_mean = mean(bias_score, na.rm=TRUE))

trend_model <- lm(monthly_mean ~ year_month, data=monthly_bias)
summary(trend_model)
MannKendall(monthly_bias$monthly_mean)

monthly_bias$month <- factor(month(monthly_bias$year_month), labels = month.abb)

seasonal_anova_bias <- aov(monthly_mean ~ month, data=monthly_bias)

summary(seasonal_anova_bias)
TukeyHSD(seasonal_anova_bias)

plot(monthly_bias$month, monthly_bias$monthly_mean, main="Monthly Mean Bias Scores", xlab="Month", ylab="Bias Scores")


monthly_country <- df_all_countries |> group_by(location, year_month) |> summarize(monthly_mean = mean(bias_score, na.rm=TRUE)) |> ungroup()

monthly_country$time_index <- as.numeric(monthly_country$year_month)

trend_country_model <- lm(monthly_mean ~ time_index * location, data=monthly_country)

summary(trend_country_model)

```