---
title: "Time Series Analysis"
format: html
editor: visual
---

## Introduction

This document contains time series analysis for the DSAN5100 final project.

# Load data files and preprocess

```{r}
# Load required libraries for R
library(tidyverse)
library(lubridate)
library(arrow)
library(plotly)
library(zoo)
library(forecast)  # For ACF and time series functions

# Set Arrow option to skip null characters
options(arrow.skip_nul = TRUE)

# Set seed for reproducibility
set.seed(42)
```

```{r}
# Load the data

argentina_df <- read_parquet("data/argentina_data_final.parquet")
canada_df <- read_parquet("data/canada_data_final.parquet")
china_df <- read_parquet("data/china_data_final.parquet")
india_df <- read_parquet("data/india_data_final.parquet")
italy_df <- read_parquet("data/italy_data_final.parquet")
russia_df <- read_parquet("data/russia_data_final.parquet")
us_df <- read_parquet("data/us_data_final.parquet")


head(us_df)
```

```{r}
# Change publishedAt column into a date type

# Function to convert publishedAt to date type
convert_date_column <- function(df) {
  df <- df %>%
    mutate(publishedAt = as.Date(publishedAt))
  return(df)
}

# Apply date conversion to all dataframes
argentina_df <- convert_date_column(argentina_df)
canada_df <- convert_date_column(canada_df)
china_df <- convert_date_column(china_df)
india_df <- convert_date_column(india_df)
italy_df <- convert_date_column(italy_df)
russia_df <- convert_date_column(russia_df)
us_df <- convert_date_column(us_df)

# Check the data type conversion
cat("Date type conversion completed:\n")
cat("publishedAt column type for US data:", class(us_df$publishedAt), "\n")
```


```{r}
# Check date range for various country data

cat("Date range for US data:", as.character(range(us_df$publishedAt, na.rm = TRUE)), "\n")
cat("Date range for Argentina data:", as.character(range(argentina_df$publishedAt, na.rm = TRUE)), "\n")
cat("Date range for Canada data:", as.character(range(canada_df$publishedAt, na.rm = TRUE)), "\n")
cat("Date range for China data:", as.character(range(china_df$publishedAt, na.rm = TRUE)), "\n")
cat("Date range for India data:", as.character(range(india_df$publishedAt, na.rm = TRUE)), "\n")
cat("Date range for Italy data:", as.character(range(italy_df$publishedAt, na.rm = TRUE)), "\n")
cat("Date range for Russia data:", as.character(range(russia_df$publishedAt, na.rm = TRUE)), "\n")
```

*All of the countries have an end date of 2021-11-29 after which the data was no longer collected. The earliest data for the published articles range from 2010-11-24 for Russia to 2019-11-23 for China*

```{r}
# Combine the country datasets into df_countries

# Set Arrow option to handle null characters
options(arrow.skip_nul = TRUE)

df_countries <- bind_rows(
  us_df, 
  canada_df, 
  china_df, 
  india_df, 
  italy_df, 
  russia_df, 
  argentina_df
)

# Check the combined dataset
cat("Combined dataset dimensions:", nrow(df_countries), "rows,", ncol(df_countries), "columns\n")
cat("Countries included:", unique(df_countries$location), "\n")
```

```{r}
# Filter the dataset to start from 2020 for more focused analysis

df_countries_2020 <- df_countries %>% filter(year > 2019)
```


# Overall country sentiment trends by category

```{r}
# View distribution of sentiment by category

df_countries %>%
  ggplot(aes(x = category, y = compound, fill = category)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Sentiment by Category",
       x = "Category",
       y = "Compound Sentiment Score") +
  theme_minimal() +
  guides(fill = "none")  
```

*The average sentiment across all categories is neutral (~0).*

*NOTE: Typical threshold values (used in literature cited on the vaderSentiment documentation) are:*
- *Positive sentiment: compound score >= 0.05*
- *Neutral sentiment: compound score > -0.05 and compound score < 0.05*
- *Negative sentiment: compound score <= -0.05*

**General Category**

```{r}
# Average sentiment (compound score) time series by country in the general category

# Transform dataframe to only include general category, countries as columns, data as row index, values as average sentiment score
general_df <- df_countries_2020 %>%
  filter(category == "general") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(location, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(location, year_month, avg_compound) %>%
  pivot_wider(
    names_from = location, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)
```

```{r}
# Visualize combined time series plots

general_plot <- ggplot(general_df, aes(x = date)) + 
  geom_line(aes(y = Argentina, color = "Argentina"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Canada, color = "Canada"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = China, color = "China"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = India, color = "India"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Italy, color = "Italy"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `Russian Federation`, color = "Russia"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `United States`, color = "United States"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average General Sentiment for the Countries",
    subtitle = "From 2020 - 2021 (Full timeline shown for all countries)",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Countries"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  scale_x_date(
    limits = c(as.Date("2020-01-01"), as.Date("2021-12-31")),
    date_breaks = "6 months", 
    date_labels = "%Y-%m"
  )

ggplotly(general_plot) %>%
  layout(hovermode = "x")
```

*In the general news category, most countries have an average sentiment score of neutral (-0.05 < compound score < 0.05) except for the USA and China. China sentiment score is significant more positive (>0.05) while the USA sentiment score leans into negative across time (<0.05)*

*The observation about China might be due to state controlled media resulting in positive news most of the time. The observation about the US might be due to how polarized the US is leading to constant feed of slightly negative news in general.*

*Except for China, the time series plots for the rest of the countries tend to skew towards negative. Research shows that news tends to skew negative due to negativity bias where humans naturally pay more attention to negative information*

**Business category**

```{r}
# Average sentiment (compound score) time series by country in the business category

# Transform dataframe to only include business category, countries as columns, data as row index, values as average sentiment score
business_df <- df_countries_2020 %>%
  filter(category == "business") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(location, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(location, year_month, avg_compound) %>%
  pivot_wider(
    names_from = location, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(business_df)
```

```{r}
# Visualize combined time series plots

business_plot <- ggplot(business_df, aes(x = date)) + 
  geom_line(aes(y = Argentina, color = "Argentina"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Canada, color = "Canada"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = China, color = "China"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = India, color = "India"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Italy, color = "Italy"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `Russian Federation`, color = "Russia"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `United States`, color = "United States"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Business Sentiment for the Countries",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Countries"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(business_plot) %>%
  layout(hovermode = "x")
```

**Health**

```{r}
# Average sentiment (compound score) time series by country in the health category

# Transform dataframe to only include health category, countries as columns, data as row index, values as average sentiment score
health_df <- df_countries_2020 %>%
  filter(category == "health") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(location, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(location, year_month, avg_compound) %>%
  pivot_wider(
    names_from = location, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(health_df)
```

```{r}
# Visualize combined time series plots

health_plot <- ggplot(health_df, aes(x = date)) + 
  geom_line(aes(y = Argentina, color = "Argentina"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Canada, color = "Canada"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = China, color = "China"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = India, color = "India"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Italy, color = "Italy"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `Russian Federation`, color = "Russia"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `United States`, color = "United States"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Health Sentiment for the Countries",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Countries"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(health_plot) %>%
  layout(hovermode = "x")
```

**Technology**

```{r}
# Average sentiment (compound score) time series by country in the technology category

# Transform dataframe to only include technology category, countries as columns, data as row index, values as average sentiment score
technology_df <- df_countries_2020 %>%
  filter(category == "technology") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(location, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(location, year_month, avg_compound) %>%
  pivot_wider(
    names_from = location, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(technology_df)
```

```{r}
# Visualize combined time series plots

technology_plot <- ggplot(technology_df, aes(x = date)) + 
  geom_line(aes(y = Argentina, color = "Argentina"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Canada, color = "Canada"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = China, color = "China"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = India, color = "India"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Italy, color = "Italy"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `Russian Federation`, color = "Russia"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `United States`, color = "United States"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Technology Sentiment for the Countries",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Countries"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(technology_plot) %>%
  layout(hovermode = "x")
```

**Entertainment**

```{r}
# Average sentiment (compound score) time series by country in the entertainment category

# Transform dataframe to only include entertainment category, countries as columns, data as row index, values as average sentiment score
entertainment_df <- df_countries_2020 %>%
  filter(category == "entertainment") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(location, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(location, year_month, avg_compound) %>%
  pivot_wider(
    names_from = location, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(entertainment_df)
```

```{r}
# Visualize combined time series plots

entertainment_plot <- ggplot(entertainment_df, aes(x = date)) + 
  geom_line(aes(y = Argentina, color = "Argentina"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Canada, color = "Canada"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = China, color = "China"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = India, color = "India"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Italy, color = "Italy"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `Russian Federation`, color = "Russia"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `United States`, color = "United States"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Entertainment Sentiment for the Countries",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Countries"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(entertainment_plot) %>%
  layout(hovermode = "x")
```

**Sports**

```{r}
# Average sentiment (compound score) time series by country in the sports category

# Transform dataframe to only include sports category, countries as columns, data as row index, values as average sentiment score
sports_df <- df_countries_2020 %>%
  filter(category == "sports") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(location, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(location, year_month, avg_compound) %>%
  pivot_wider(
    names_from = location, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(sports_df)
```

```{r}
# Visualize combined time series plots

sports_plot <- ggplot(sports_df, aes(x = date)) + 
  geom_line(aes(y = Argentina, color = "Argentina"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Canada, color = "Canada"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = China, color = "China"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = India, color = "India"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Italy, color = "Italy"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `Russian Federation`, color = "Russia"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `United States`, color = "United States"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Sports Sentiment for the Countries",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Countries"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(sports_plot) %>%
  layout(hovermode = "x")
```

**Science**

```{r}
# Average sentiment (compound score) time series by country in the science category

# Transform dataframe to only include science category, countries as columns, data as row index, values as average sentiment score
science_df <- df_countries_2020 %>%
  filter(category == "science") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(location, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(location, year_month, avg_compound) %>%
  pivot_wider(
    names_from = location, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(science_df)
```

```{r}
# Visualize combined time series plots

science_plot <- ggplot(science_df, aes(x = date)) + 
  geom_line(aes(y = Argentina, color = "Argentina"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Canada, color = "Canada"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = China, color = "China"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = India, color = "India"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = Italy, color = "Italy"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `Russian Federation`, color = "Russia"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = `United States`, color = "United States"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Science Sentiment for the Countries",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Countries"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(science_plot) %>%
  layout(hovermode = "x")
```

# Analysis of sentiment and bias in USA news

**Sentiment Analysis**

```{r}
# Average sentiment by category

# Transform df_country to only include USA, then date, categories as columns, and average sentiment as values
usa_df <- df_countries %>%
  filter(location == "United States") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(category, year_month) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(category, year_month, avg_compound) %>%
  pivot_wider(
    names_from = category, 
    values_from = avg_compound
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(usa_df)
```

```{r}
# Time series plot for average sentiment by category

usa_category_plot <- ggplot(usa_df, aes(x = date)) + 
  geom_line(aes(y = general, color = "General"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = business, color = "Business"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = health, color = "Health"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = technology, color = "Technology"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = entertainment, color = "Entertainment"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = sports, color = "Sports"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = science, color = "Science"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Sentiment by Category for USA News",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average sentiment score (-1 to 1)",
    color = "Category"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  scale_x_date(
    limits = c(as.Date("2020-01-01"), as.Date("2021-12-31")),
    date_breaks = "6 months", 
    date_labels = "%Y-%m"
  )

ggplotly(usa_category_plot) %>%
  layout(hovermode = "x")
```

```{r}
# Compare average sentiment across categories (boxplot)

df_countries %>%
  filter(location == "United States") %>%
  ggplot(aes(x = category, y = compound, fill = category)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Sentiment Distribution by Category for USA News",
       subtitle = "From 2020 - 2021",
       x = "Category",
       y = "Compound Sentiment Score") +
  theme_minimal() +
  guides(fill = "none")
```

```{r}
# Summary Sentiment statistics by category for USA

usa_category_summary <- df_countries_2020 %>%
  filter(location == "United States") %>%
  group_by(category) %>%
  summarise(
    mean_sentiment = mean(compound, na.rm = TRUE),
    median_sentiment = median(compound, na.rm = TRUE),
    sd_sentiment = sd(compound, na.rm = TRUE),
    min_sentiment = min(compound, na.rm = TRUE),
    max_sentiment = max(compound, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  arrange(desc(mean_sentiment))

print(usa_category_summary)
```

**Bias Analysis**

```{r}
# Average bias by category

# Transform df_country to only include USA, then date, categories as columns, and average bias as values
usa_bias_df <- df_countries %>%
  filter(location == "United States") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(category, year_month) %>%
  summarise(
    avg_bias = mean(bias_score, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  select(category, year_month, avg_bias) %>%
  pivot_wider(
    names_from = category, 
    values_from = avg_bias
  ) %>%
  arrange(year_month) %>%
  rename(date = year_month)

head(usa_bias_df)
```

```{r}
# Time series plot for average bias by category

usa_bias_plot <- ggplot(usa_bias_df, aes(x = date)) + 
  geom_line(aes(y = general, color = "General"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = business, color = "Business"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = health, color = "Health"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = technology, color = "Technology"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = entertainment, color = "Entertainment"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = sports, color = "Sports"), size = 1, na.rm = TRUE) +
  geom_line(aes(y = science, color = "Science"), size = 1, na.rm = TRUE) +
  labs(
    title = "Average Bias by Category for USA News",
    subtitle = "From 2020 - 2021",
    x = "Date",
    y = "Average bias score (0 to 1)",
    color = "Category"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  scale_x_date(
    limits = c(as.Date("2020-01-01"), as.Date("2021-12-31")),
    date_breaks = "6 months", 
    date_labels = "%Y-%m"
  )

ggplotly(usa_bias_plot) %>%
  layout(hovermode = "x")
```

```{r}
# Compare average bias across categories (boxplot)

df_countries %>%
  filter(location == "United States") %>%
  ggplot(aes(x = category, y = bias_score, fill = category)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Bias Distribution by Category for USA News",
       subtitle = "From 2020 - 2021",
       x = "Category",
       y = "Bias Score") +
  theme_minimal() +
  guides(fill = "none")
```

```{r}
# Summary Bias statistics by category for USA bias

usa_bias_summary <- df_countries %>%
  filter(location == "United States") %>%
  group_by(category) %>%
  summarise(
    mean_bias = mean(bias_score, na.rm = TRUE),
    median_bias = median(bias_score, na.rm = TRUE),
    sd_bias = sd(bias_score, na.rm = TRUE),
    min_bias = min(bias_score, na.rm = TRUE),
    max_bias = max(bias_score, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  arrange(desc(mean_bias))

print(usa_bias_summary)
```

**Deep Dive into Health and Science trends during the pandemic**

```{r}
# Combined time series plot for sentiment and bias in the health category, daily

# Prepare daily health data for USA with both sentiment and bias
usa_health_daily <- df_countries %>%
  filter(location == "United States", category == "health") %>%
  group_by(publishedAt) %>%
  summarise(
    avg_sentiment = mean(compound, na.rm = TRUE),
    avg_bias = mean(bias_score, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  rename(date = publishedAt) %>%
  # Transform to long format for plotting
  pivot_longer(
    cols = c(avg_sentiment, avg_bias),
    names_to = "metric",
    values_to = "score"
  ) %>%
  mutate(
    metric = case_when(
      metric == "avg_sentiment" ~ "Sentiment",
      metric == "avg_bias" ~ "Bias"
    )
  )

head(usa_health_daily)
```

```{r}
# Create combined plot with dual y-axes

# Create the base plot with sentiment
usa_health_combined_plot <- ggplot(usa_health_daily, aes(x = date, y = score, color = metric)) +
  geom_line(size = 0.5, alpha = 0.7) +
  facet_wrap(~ metric, scales = "free_y", ncol = 1) +
  labs(
    title = "Daily Sentiment and Bias Trends for USA Health News",
    subtitle = "From 2020 - 2021 (Pandemic Period)",
    x = "Date",
    y = "Score",
    color = "Metric"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "bold")
  ) +
  scale_x_date(
    limits = c(as.Date("2020-01-01"), as.Date("2021-12-31")),
    date_breaks = "3 months", 
    date_labels = "%Y-%m"
  ) +
  scale_color_manual(values = c("Sentiment" = "#2E86AB", "Bias" = "#A23B72"))

ggplotly(usa_health_combined_plot) %>%
  layout(hovermode = "x")
```

```{r}
# Decomposition of health sentiment time series in the USA

# Prepare monthly aggregated health sentiment data for USA
usa_health_monthly <- df_countries %>%
  filter(location == "United States", category == "health") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(year_month) %>%
  summarise(avg_sentiment = mean(compound, na.rm = TRUE), .groups = 'drop') %>%
  arrange(year_month)

# Create time series object with monthly frequency
health_ts <- ts(usa_health_monthly$avg_sentiment, start = c(2018, 1), frequency = 12)

# Decompose (additive by default)
dec <- decompose(health_ts)
```

```{r}

# Time index
t <- time(health_ts)

# Make four simple plots
p1 <- plot_ly(x = ~t, y = ~as.numeric(dec$x),        type = "scatter", mode = "lines", name = "Observed",  showlegend = FALSE)
p2 <- plot_ly(x = ~t, y = ~as.numeric(dec$trend),    type = "scatter", mode = "lines", name = "Trend",     showlegend = FALSE)
p3 <- plot_ly(x = ~t, y = ~as.numeric(dec$seasonal), type = "scatter", mode = "lines", name = "Seasonal",  showlegend = FALSE)
p4 <- plot_ly(x = ~t, y = ~as.numeric(dec$random),   type = "scatter", mode = "lines", name = "Remainder", showlegend = FALSE)

subplot(p1, p2, p3, p4, nrows = 4, shareX = TRUE) |>
  layout(
    title = "Decomposition of USA Health Sentiment (2020-2021)",
    xaxis  = list(title = "Year"),
    yaxis  = list(title = "Observed", nticks = 5, tickfont = list(size = 10)),
    yaxis2 = list(title = "Trend",    nticks = 5, tickfont = list(size = 10)),
    yaxis3 = list(title = "Seasonal", nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    yaxis4 = list(title = "Remainder",nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    margin = list(l = 70, r = 10, t = 40, b = 40)
  )

```

```{r}
# Decomposition of health bias time series in the USA

# Prepare monthly aggregated health bias data for USA
usa_health_bias_monthly <- df_countries %>%
  filter(location == "United States", category == "health") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(year_month) %>%
  summarise(avg_bias = mean(bias_score, na.rm = TRUE), .groups = 'drop') %>%
  arrange(year_month)

# Create time series object with monthly frequency
bias_ts <- ts(usa_health_bias_monthly$avg_bias, start = c(2018, 1), frequency = 12)

# Decompose (additive by default)
dec <- decompose(bias_ts)
```

```{r}
# Time index
t <- time(bias_ts)

# Make four simple plots
p1 <- plot_ly(x = ~t, y = ~as.numeric(dec$x),        type = "scatter", mode = "lines", name = "Observed",  showlegend = FALSE)
p2 <- plot_ly(x = ~t, y = ~as.numeric(dec$trend),    type = "scatter", mode = "lines", name = "Trend",     showlegend = FALSE)
p3 <- plot_ly(x = ~t, y = ~as.numeric(dec$seasonal), type = "scatter", mode = "lines", name = "Seasonal",  showlegend = FALSE)
p4 <- plot_ly(x = ~t, y = ~as.numeric(dec$random),   type = "scatter", mode = "lines", name = "Remainder", showlegend = FALSE)

subplot(p1, p2, p3, p4, nrows = 4, shareX = TRUE) |>
  layout(
    title = "Decomposition of USA Health bias (2020-2021)",
    xaxis  = list(title = "Year"),
    yaxis  = list(title = "Observed", nticks = 5, tickfont = list(size = 10)),
    yaxis2 = list(title = "Trend",    nticks = 5, tickfont = list(size = 10)),
    yaxis3 = list(title = "Seasonal", nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    yaxis4 = list(title = "Remainder",nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    margin = list(l = 70, r = 10, t = 40, b = 40)
  )
```

*Similar decomposition for science category*

```{r}
# Decomposition of science sentiment time series in the USA

# Prepare monthly aggregated science sentiment data for USA
usa_science_monthly <- df_countries %>%
  filter(location == "United States", category == "science") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(year_month) %>%
  summarise(avg_sentiment = mean(compound, na.rm = TRUE), .groups = 'drop') %>%
  arrange(year_month)

# Create time series object with monthly frequency
science_ts <- ts(usa_science_monthly$avg_sentiment, start = c(2018, 1), frequency = 12)

# Decompose (additive by default)
dec <- decompose(science_ts)
```

```{r}

# Time index
t <- time(science_ts)

# Make four simple plots
p1 <- plot_ly(x = ~t, y = ~as.numeric(dec$x),        type = "scatter", mode = "lines", name = "Observed",  showlegend = FALSE)
p2 <- plot_ly(x = ~t, y = ~as.numeric(dec$trend),    type = "scatter", mode = "lines", name = "Trend",     showlegend = FALSE)
p3 <- plot_ly(x = ~t, y = ~as.numeric(dec$seasonal), type = "scatter", mode = "lines", name = "Seasonal",  showlegend = FALSE)
p4 <- plot_ly(x = ~t, y = ~as.numeric(dec$random),   type = "scatter", mode = "lines", name = "Remainder", showlegend = FALSE)

subplot(p1, p2, p3, p4, nrows = 4, shareX = TRUE) |>
  layout(
    title = "Decomposition of USA Science Sentiment (2020-2021)",
    xaxis  = list(title = "Year"),
    yaxis  = list(title = "Observed", nticks = 5, tickfont = list(size = 10)),
    yaxis2 = list(title = "Trend",    nticks = 5, tickfont = list(size = 10)),
    yaxis3 = list(title = "Seasonal", nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    yaxis4 = list(title = "Remainder",nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    margin = list(l = 70, r = 10, t = 40, b = 40)
  )

```

```{r}
# Decomposition of science bias time series in the USA

# Prepare monthly aggregated science bias data for USA
usa_science_bias_monthly <- df_countries %>%
  filter(location == "United States", category == "science") %>%
  mutate(year_month = floor_date(publishedAt, "month")) %>%
  group_by(year_month) %>%
  summarise(avg_bias = mean(bias_score, na.rm = TRUE), .groups = 'drop') %>%
  arrange(year_month)

# Create time series object with monthly frequency
bias_ts <- ts(usa_science_bias_monthly$avg_bias, start = c(2018, 1), frequency = 12)

# Decompose (additive by default)
dec <- decompose(bias_ts)
```

```{r}
# Time index
t <- time(bias_ts)

# Make four simple plots
p1 <- plot_ly(x = ~t, y = ~as.numeric(dec$x),        type = "scatter", mode = "lines", name = "Observed",  showlegend = FALSE)
p2 <- plot_ly(x = ~t, y = ~as.numeric(dec$trend),    type = "scatter", mode = "lines", name = "Trend",     showlegend = FALSE)
p3 <- plot_ly(x = ~t, y = ~as.numeric(dec$seasonal), type = "scatter", mode = "lines", name = "Seasonal",  showlegend = FALSE)
p4 <- plot_ly(x = ~t, y = ~as.numeric(dec$random),   type = "scatter", mode = "lines", name = "Remainder", showlegend = FALSE)

subplot(p1, p2, p3, p4, nrows = 4, shareX = TRUE) |>
  layout(
    title = "Decomposition of USA Science Bias (2020-2021)",
    xaxis  = list(title = "Year"),
    yaxis  = list(title = "Observed", nticks = 5, tickfont = list(size = 10)),
    yaxis2 = list(title = "Trend",    nticks = 5, tickfont = list(size = 10)),
    yaxis3 = list(title = "Seasonal", nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    yaxis4 = list(title = "Remainder",nticks = 3, tickformat = ".3f", tickfont = list(size = 10)),
    margin = list(l = 70, r = 10, t = 40, b = 40)
  )
```

**Analysis of top sources for health**

```{r}
# View main sources of news for science and health category in the USA

# Analyze top news sources for health and science categories
usa_sources_health_science <- df_countries %>%
  filter(location == "United States", category %in% c("health", "science")) %>%
  group_by(category, `source-name`) %>%
  summarise(
    n_articles = n(),
    avg_sentiment = mean(compound, na.rm = TRUE),
    avg_bias = mean(bias_score, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(category, desc(n_articles))

# Get top 10 sources for each category
top_sources_health <- usa_sources_health_science %>%
  filter(category == "health") %>%
  slice_head(n = 10)

top_sources_science <- usa_sources_health_science %>%
  filter(category == "science") %>%
  slice_head(n = 10)

# Display the results
cat("Top 10 Health News Sources in USA (2020-2021):\n")
print(top_sources_health)

cat("\nTop 10 Science News Sources in USA (2020-2021):\n")
print(top_sources_science)
```

```{r}
# Create visualization for top news sources by article count

# Health News Sources Visualization
df_usa_health <- df_countries_2020 %>%
  filter(location == "United States", category == "health")

# Top 20 health news sources
top_health_sources <- df_usa_health %>%
  count(`source-name`, sort = TRUE) %>%
  slice_head(n = 20)

# Horizontal bar chart for health sources
health_sources_plot <- plot_ly(
  data = top_health_sources,
  x = ~n,
  y = ~reorder(`source-name`, n),
  type = 'bar',
  orientation = 'h',
  marker = list(color = '#E74C3C'),
  name = 'Health Sources'
) %>%
  layout(
    title = list(
      text = 'Top 20 USA Health News Sources by Article Count (2020-2021)',
      font = list(family = "Times New Roman")
    ),
    xaxis = list(title = 'Article Count'),
    yaxis = list(title = 'News Source'),
    margin = list(l = 150)
  )

health_sources_plot
```

```{r}
# Science News Sources Visualization
df_usa_science <- df_countries_2020 %>%
  filter(location == "United States", category == "science")

# Top 20 science news sources
top_science_sources <- df_usa_science %>%
  count(`source-name`, sort = TRUE) %>%
  slice_head(n = 20)

# Horizontal bar chart for science sources
science_sources_plot <- plot_ly(
  data = top_science_sources,
  x = ~n,
  y = ~reorder(`source-name`, n),
  type = 'bar',
  orientation = 'h',
  marker = list(color = '#3498DB'),
  name = 'Science Sources'
) %>%
  layout(
    title = list(
      text = 'Top 20 USA Science News Sources by Article Count (2020-2021)',
      font = list(family = "Times New Roman")
    ),
    xaxis = list(title = 'Article Count'),
    yaxis = list(title = 'News Source'),
    margin = list(l = 150)
  )

science_sources_plot
```

```{r}
# Average Sentiment for top 5 health sources

# Get top 5 health sources for sentiment analysis
top_5_health_sentiment <- top_sources_health %>%
  slice_head(n = 5)

# Create vertical bar chart for health sentiment
health_sentiment_plot <- plot_ly(
  data = top_5_health_sentiment,
  x = ~reorder(`source-name`, avg_sentiment),
  y = ~avg_sentiment,
  type = 'bar',
  marker = list(color = '#27AE60'),
  name = 'Health Sentiment',
  text = ~paste("Articles:", n_articles, "<br>Sentiment:", round(avg_sentiment, 3)),
  textposition = 'auto'
) %>%
  layout(
    title = list(
      text = 'Average Sentiment for Top 5 USA Health News Sources (2020-2021)',
      font = list(family = "Times New Roman")
    ),
    xaxis = list(title = 'News Source'),
    yaxis = list(title = 'Average Sentiment Score'),
    margin = list(b = 100)
  )

health_sentiment_plot
```

```{r}
# Average Bias for top 5 health sources

# Get top 5 health sources for bias analysis
top_5_health_bias <- top_sources_health %>%
  slice_head(n = 5)

# Create vertical bar chart for health bias
health_bias_plot <- plot_ly(
  data = top_5_health_bias,
  x = ~reorder(`source-name`, avg_bias),
  y = ~avg_bias,
  type = 'bar',
  marker = list(color = '#E67E22'),
  name = 'Health Bias',
  text = ~paste("Articles:", n_articles, "<br>Bias:", round(avg_bias, 3)),
  textposition = 'auto'
) %>%
  layout(
    title = list(
      text = 'Average Bias for Top 5 USA Health News Sources (2020-2021)',
      font = list(family = "Times New Roman")
    ),
    xaxis = list(title = 'News Source'),
    yaxis = list(title = 'Average Bias Score'),
    margin = list(b = 100)
  )

health_bias_plot
```

```{r}
# Average Sentiment for top 5 science sources

# Get top 5 science sources for sentiment analysis
top_5_science_sentiment <- top_sources_science %>%
  slice_head(n = 5)

# Create vertical bar chart for science sentiment
science_sentiment_plot <- plot_ly(
  data = top_5_science_sentiment,
  x = ~reorder(`source-name`, avg_sentiment),
  y = ~avg_sentiment,
  type = 'bar',
  marker = list(color = '#8E44AD'),
  name = 'Science Sentiment',
  text = ~paste("Articles:", n_articles, "<br>Sentiment:", round(avg_sentiment, 3)),
  textposition = 'auto'
) %>%
  layout(
    title = list(
      text = 'Average Sentiment for Top 5 USA Science News Sources (2020-2021)',
      font = list(family = "Times New Roman")
    ),
    xaxis = list(title = 'News Source'),
    yaxis = list(title = 'Average Sentiment Score'),
    margin = list(b = 100)
  )

science_sentiment_plot
```

```{r}
# Average Bias for top 5 science sources

# Get top 5 science sources for bias analysis
top_5_science_bias <- top_sources_science %>%
  slice_head(n = 5)

# Create vertical bar chart for science bias
science_bias_plot <- plot_ly(
  data = top_5_science_bias,
  x = ~reorder(`source-name`, avg_bias),
  y = ~avg_bias,
  type = 'bar',
  marker = list(color = '#E74C3C'),
  name = 'Science Bias',
  text = ~paste("Articles:", n_articles, "<br>Bias:", round(avg_bias, 3)),
  textposition = 'auto'
) %>%
  layout(
    title = list(
      text = 'Average Bias for Top 5 USA Science News Sources (2020-2021)',
      font = list(family = "Times New Roman")
    ),
    xaxis = list(title = 'News Source'),
    yaxis = list(title = 'Average Bias Score'),
    margin = list(b = 100)
  )

science_bias_plot
```

# Time Series for sentiment in the USA

```{r}
# Create US data frame with publishedAt, category, year, month, avg_compound, and avg_bias

# Create aggregated US data frame by date and category
us_daily_df <- df_countries %>%
  filter(location == "United States") %>%
  group_by(publishedAt, category) %>%
  summarise(
    avg_compound = mean(compound, na.rm = TRUE),
    avg_bias = mean(bias_score, na.rm = TRUE),
    n_articles = n(),
    .groups = 'drop'
  ) %>%
  mutate(
    year = year(publishedAt),
    month = month(publishedAt)
  ) %>%
  select(publishedAt, category, year, month, avg_compound, avg_bias, n_articles) %>%
  arrange(publishedAt, category)

# Display first few rows and summary
head(us_daily_df, 10)
```

```{r}
# Extract day from date e.g., 1 for Sunday, 2 for Monday, etc.

# Add day of week information to the US daily dataframe
us_daily_df <- us_daily_df %>%
  mutate(
    # wday() returns 1 for Sunday, 2 for Monday, ..., 7 for Saturday
    day_of_week = wday(publishedAt),
    # wday() with label=TRUE, abbr=FALSE returns full day names  
    day_full_name = wday(publishedAt, label = TRUE, abbr = FALSE)
  )

# Display updated dataframe with day information
head(us_daily_df, 10)
```

```{r}
# Run a regression sentiment score on bias score, category, day_of_week

us_sentiment_model <- lm(avg_compound ~ avg_bias + as.factor(day_of_week) + as.factor(category), us_daily_df)

summary(us_sentiment_model)
```

```{r}
# Convert residuals to time series component and look at the residuals ACF

# Extract residuals from the regression model
residuals_data <- residuals(us_sentiment_model)

# Create a dataframe with residuals and dates for proper ordering
residuals_df <- data.frame(
  residuals = residuals_data,
  publishedAt = us_daily_df$publishedAt,
  category = us_daily_df$category
) %>%
  arrange(publishedAt)

# Convert residuals to time series object
# Note: Since we have irregular time series (not every day has data for every category),
# we'll work with the residuals as a vector for ACF analysis
res_fit <- residuals_df$residuals

# Create ACF plot for residuals
acf_plot <- ggAcf(res_fit, lag.max = 40) +
  labs(
    title = "Autocorrelation Function (ACF) of Regression Residuals",
    subtitle = "US Daily News Sentiment Model Residuals",
    x = "Lag",
    y = "ACF"
  ) +
  theme_minimal()

print(acf_plot)
```

```{r}
# Lag plot for sentiment in USA

# Create a time series of daily average sentiment for USA
usa_sentiment_daily <- us_daily_df %>%
  group_by(publishedAt) %>%
  summarise(
    daily_avg_sentiment = mean(avg_compound, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(publishedAt) %>%
  filter(!is.na(daily_avg_sentiment))

# Convert to time series object
usa_sentiment.ts <- ts(usa_sentiment_daily$daily_avg_sentiment, frequency = 365)

# Create lag plots with 4 different lags
gglagplot(usa_sentiment.ts, do.lines = FALSE, lags = 4) +
  labs(
    title = "Lag Plots: USA Daily Sentiment Analysis",
    subtitle = "Autocorrelation patterns in daily sentiment data",
    x = "Y(t-k)",
    y = "Y(t)"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )
```

```{r}
# Lag plot for bias in USA

# Create a time series of daily average bias for USA
usa_bias_daily <- us_daily_df %>%
  group_by(publishedAt) %>%
  summarise(
    daily_avg_bias = mean(avg_bias, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(publishedAt) %>%
  filter(!is.na(daily_avg_bias))

# Convert to time series object
usa_bias.ts <- ts(usa_bias_daily$daily_avg_bias, frequency = 365)

# Create lag plots with 4 different lags
gglagplot(usa_bias.ts, do.lines = FALSE, lags = 4) +
  labs(
    title = "Lag Plots: USA Daily Bias Analysis",
    subtitle = "Autocorrelation patterns in daily bias data",
    x = "Y(t-k)",
    y = "Y(t)"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )
```

```{r}
# ACF plot for USA daily sentiment
ggAcf(usa_sentiment_daily$daily_avg_sentiment, lag.max = 40) +
  labs(
    title = "Autocorrelation Function (ACF): USA Daily Sentiment",
    subtitle = "Identifying temporal dependencies in daily sentiment data",
    x = "Lag (days)",
    y = "ACF"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )
```

```{r}
# PACF plot for USA daily sentiment
ggPacf(usa_sentiment_daily$daily_avg_sentiment, lag.max = 40) +
  labs(
    title = "Partial Autocorrelation Function (PACF): USA Daily Sentiment",
    subtitle = "Identifying direct temporal relationships in daily sentiment data",
    x = "Lag (days)",
    y = "PACF"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )
```




